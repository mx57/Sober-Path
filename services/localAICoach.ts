// –£–ª—É—á—à–µ–Ω–Ω—ã–π AI-–∫–æ—É—á —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–π –±–∞–∑–æ–π –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏—Ö –∑–Ω–∞–Ω–∏–π

import { findRelevantKnowledge } from './psychologyKnowledgeBase';

interface AIResponse {
  message: string;
  suggestions: string[];
  resources: string[];
  mood: 'supportive' | 'motivational' | 'analytical' | 'calming';
  confidence: number; // 0-1
}

interface ConversationContext {
  userMood: number; // 1-5
  soberDays: number;
  recentChallenges: string[];
  preferredTechniques: string[];
  timeOfDay: 'morning' | 'afternoon' | 'evening' | 'night';
  urgency: 'low' | 'medium' | 'high' | 'crisis';
}

// –ë–∞–∑–æ–≤—ã–µ —à–∞–±–ª–æ–Ω—ã –æ—Ç–≤–µ—Ç–æ–≤ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Å–∏—Ç—É–∞—Ü–∏–π
const responseTemplates = {
  crisis: {
    supportive: [
      "–Ø –ø–æ–Ω–∏–º–∞—é, —á—Ç–æ —Å–µ–π—á–∞—Å –æ—á–µ–Ω—å —Ç—è–∂–µ–ª–æ. –ü–æ–º–Ω–∏—Ç–µ: —ç—Ç–æ —á—É–≤—Å—Ç–≤–æ –≤—Ä–µ–º–µ–Ω–Ω–æ. –î–∞–≤–∞–π—Ç–µ –≤–º–µ—Å—Ç–µ –Ω–∞–π–¥–µ–º —Å–ø–æ—Å–æ–± –ø—Ä–æ–π—Ç–∏ —á–µ—Ä–µ–∑ —ç—Ç–æ.",
      "–í–∞—à–∞ –±–æ–ª—å —Ä–µ–∞–ª—å–Ω–∞, –∏ –≤–∞—à–∏ —É—Å–∏–ª–∏—è —Ü–µ–Ω–Ω—ã. –ö–∞–∂–¥–∞—è —Å–µ–∫—É–Ω–¥–∞, –∫–æ–≥–¥–∞ –≤—ã –≤—ã–±–∏—Ä–∞–µ—Ç–µ —Ç—Ä–µ–∑–≤–æ—Å—Ç—å, - —ç—Ç–æ –∞–∫—Ç —Å–º–µ–ª–æ—Å—Ç–∏.",
      "–°–µ–π—á–∞—Å —Å–∞–º–æ–µ –≤–∞–∂–Ω–æ–µ - –≤–∞—à–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å. –î—ã—à–∏—Ç–µ –º–µ–¥–ª–µ–Ω–Ω–æ –∏ –≥–ª—É–±–æ–∫–æ. –Ø –∑–¥–µ—Å—å, —á—Ç–æ–±—ã –ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å –≤–∞—Å."
    ],
    techniques: [
      "–¢–µ—Ö–Ω–∏–∫–∞ 5-4-3-2-1: –Ω–∞–∑–æ–≤–∏—Ç–µ 5 –≤–µ—â–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –≤–∏–¥–∏—Ç–µ, 4 - –∫–æ—Ç–æ—Ä—ã–µ —Å–ª—ã—à–∏—Ç–µ, 3 - –∫–æ—Ç–æ—Ä—ã–µ —á—É–≤—Å—Ç–≤—É–µ—Ç–µ, 2 - –∫–æ—Ç–æ—Ä—ã–µ –Ω—é—Ö–∞–µ—Ç–µ, 1 - –∫–æ—Ç–æ—Ä—É—é –ø—Ä–æ–±—É–µ—Ç–µ.",
      "–ö–≤–∞–¥—Ä–∞—Ç–Ω–æ–µ –¥—ã—Ö–∞–Ω–∏–µ: –≤–¥–æ—Ö 4 —Å—á–µ—Ç–∞, –∑–∞–¥–µ—Ä–∂–∫–∞ 4, –≤—ã–¥–æ—Ö 4, –∑–∞–¥–µ—Ä–∂–∫–∞ 4. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ 5 —Ä–∞–∑.",
      "–•–æ–ª–æ–¥–Ω–∞—è –≤–æ–¥–∞: —É–º–æ–π—Ç–µ—Å—å —Ö–æ–ª–æ–¥–Ω–æ–π –≤–æ–¥–æ–π –∏–ª–∏ –ø—Ä–∏–ª–æ–∂–∏—Ç–µ –ª–µ–¥ –∫ –∑–∞–ø—è—Å—Ç—å—è–º –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —É—Å–ø–æ–∫–æ–µ–Ω–∏—è."
    ]
  },
  
  high_urgency: {
    motivational: [
      "–≠—Ç–æ —Å–ª–æ–∂–Ω—ã–π –º–æ–º–µ–Ω—Ç, –Ω–æ –≤—ã —É–∂–µ –º–Ω–æ–≥–æ —Ä–∞–∑ –¥–æ–∫–∞–∑—ã–≤–∞–ª–∏ —Å–≤–æ—é —Å–∏–ª—É. –ö–∞–∫–∞—è —Ç–µ—Ö–Ω–∏–∫–∞ –ø–æ–º–æ–≥–∞–ª–∞ –≤–∞–º —Ä–∞–Ω—å—à–µ?",
      "–¢—è–≥–∞ –∫–∞–∫ –≤–æ–ª–Ω–∞ - –æ–Ω–∞ –ø–æ–¥–Ω–∏–º–∞–µ—Ç—Å—è, –Ω–æ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Å–ø–∞–¥–µ—Ç. –î–∞–≤–∞–π—Ç–µ '—Å–µ—Ä—Ñ–∏–º' –ø–æ –Ω–µ–π –≤–º–µ—Å—Ç–µ.",
      "–í—Å–ø–æ–º–Ω–∏—Ç–µ, –ø–æ—á–µ–º—É –≤—ã –Ω–∞—á–∞–ª–∏ —ç—Ç–æ—Ç –ø—É—Ç—å. –¢–∞ –ø—Ä–∏—á–∏–Ω–∞ –≤—Å–µ –µ—â–µ –≤–∞–∂–Ω–∞ –¥–ª—è –≤–∞—Å?"
    ],
    techniques: [
      "–°–µ—Ä—Ñ–∏–Ω–≥ –ø–æ —Ç—è–≥–µ: –ø—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ —Ç—è–≥—É –∫–∞–∫ –≤–æ–ª–Ω—É, –Ω–∞–±–ª—é–¥–∞–π—Ç–µ –∑–∞ –Ω–µ–π –±–µ–∑ —Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏—è",
      "–Ø–∫–æ—Ä–µ–Ω–∏–µ —Å–∏–ª—ã: –≤—Å–ø–æ–º–Ω–∏—Ç–µ –º–æ–º–µ–Ω—Ç, –∫–æ–≥–¥–∞ —á—É–≤—Å—Ç–≤–æ–≤–∞–ª–∏ —Å–µ–±—è –æ—á–µ–Ω—å —Å–∏–ª—å–Ω—ã–º, –∏ '–∑–∞—è–∫–æ—Ä–∏—Ç–µ' —ç—Ç–æ –æ—â—É—â–µ–Ω–∏–µ",
      "–í—Ä–µ–º–µ–Ω–Ω–∞—è –ª–∏–Ω–∏—è: –ø—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ —Å–µ–±—è —á–µ—Ä–µ–∑ —á–∞—Å, –¥–µ–Ω—å, –Ω–µ–¥–µ–ª—é - –∫–∞–∫ –±—É–¥–µ—Ç–µ —Å–µ–±—è —á—É–≤—Å—Ç–≤–æ–≤–∞—Ç—å, –≤—ã–±—Ä–∞–≤ —Ç—Ä–µ–∑–≤–æ—Å—Ç—å?"
    ]
  },
  
  medium_urgency: {
    analytical: [
      "–î–∞–≤–∞–π—Ç–µ —Ä–∞–∑–±–µ—Ä–µ–º —Å–∏—Ç—É–∞—Ü–∏—é. –ß—Ç–æ –∏–º–µ–Ω–Ω–æ –∑–∞–ø—É—Å—Ç–∏–ª–æ —ç—Ç–∏ –º—ã—Å–ª–∏ –æ–± –∞–ª–∫–æ–≥–æ–ª–µ?",
      "–ó–∞–º–µ—á–∞—Ç–µ–ª—å–Ω–æ, —á—Ç–æ –≤—ã –æ–±—Ä–∞—Ç–∏–ª–∏—Å—å –∑–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π. –≠—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤–∞—à—É –æ—Å–æ–∑–Ω–∞–Ω–Ω–æ—Å—Ç—å –∏ —Å–∏–ª—É.",
      "–ö–∞–∫–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤—ã –∑–∞–º–µ—Ç–∏–ª–∏ –≤ —Å–µ–±–µ –∑–∞ –≤—Ä–µ–º—è —Ç—Ä–µ–∑–≤–æ—Å—Ç–∏? –î–∞–≤–∞–π—Ç–µ —Å—Ñ–æ–∫—É—Å–∏—Ä—É–µ–º—Å—è –Ω–∞ –ø–æ–∑–∏—Ç–∏–≤–Ω–æ–º."
    ],
    techniques: [
      "–î–Ω–µ–≤–Ω–∏–∫ –º—ã—Å–ª–µ–π CBT: –∑–∞–ø–∏—à–∏—Ç–µ —Å–∏—Ç—É–∞—Ü–∏—é, –º—ã—Å–ª–∏, —ç–º–æ—Ü–∏–∏ –∏ –Ω–∞–π–¥–∏—Ç–µ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –º—ã—Å–ª–∏",
      "–¢–µ—Ö–Ω–∏–∫–∞ –°–¢–û–ü: –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ—Å—å, –≤–¥–æ—Ö–Ω–∏—Ç–µ, –æ—Ü–µ–Ω–∏—Ç–µ —Å–∏—Ç—É–∞—Ü–∏—é, –≤—ã–±–µ—Ä–∏—Ç–µ –æ—Å–æ–∑–Ω–∞–Ω–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ",
      "–†–µ—Ñ—Ä–µ–π–º–∏–Ω–≥: –∫–∞–∫ –º–æ–∂–Ω–æ –ø–æ-–¥—Ä—É–≥–æ–º—É –≤–∑–≥–ª—è–Ω—É—Ç—å –Ω–∞ —ç—Ç—É —Å–∏—Ç—É–∞—Ü–∏—é?"
    ]
  },
  
  low_urgency: {
    calming: [
      "–ö–∞–∫ –¥–µ–ª–∞ —Å–µ–≥–æ–¥–Ω—è? –†–∞—Å—Å–∫–∞–∂–∏—Ç–µ, —á—Ç–æ –Ω–∞ –¥—É—à–µ.",
      "–ö–∞–∂–¥—ã–π –¥–µ–Ω—å —Ç—Ä–µ–∑–≤–æ—Å—Ç–∏ - —ç—Ç–æ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏—è –≤ –≤–∞—à–µ –±—É–¥—É—â–µ–µ. –ö–∞–∫ –≤—ã —Å–µ–≥–æ–¥–Ω—è –∑–∞–±–æ—Ç–∏—Ç–µ—Å—å –æ —Å–µ–±–µ?",
      "–ö–∞–∫–∏–µ –ø–æ–∑–∏—Ç–∏–≤–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤—ã –∑–∞–º–µ—á–∞–µ—Ç–µ –≤ —Å–≤–æ–µ–π –∂–∏–∑–Ω–∏?"
    ],
    techniques: [
      "–ú–µ–¥–∏—Ç–∞—Ü–∏—è –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏: –ø–æ–¥—É–º–∞–π—Ç–µ –æ —Ç—Ä–µ—Ö –≤–µ—â–∞—Ö, –∑–∞ –∫–æ—Ç–æ—Ä—ã–µ –±–ª–∞–≥–æ–¥–∞—Ä–Ω—ã —Å–µ–≥–æ–¥–Ω—è",
      "–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è —Ü–µ–ª–∏: –ø—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ —Å–≤–æ—é –∂–∏–∑–Ω—å —á–µ—Ä–µ–∑ –≥–æ–¥ —Ç—Ä–µ–∑–≤–æ—Å—Ç–∏",
      "–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–ª–∞: –ø—Ä–æ–π–¥–∏—Ç–µ—Å—å –≤–Ω–∏–º–∞–Ω–∏–µ–º –ø–æ —Ç–µ–ª—É –æ—Ç –≥–æ–ª–æ–≤—ã –¥–æ –ø—è—Ç"
    ]
  }
};

// –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
const personalizedResponses = {
  earlyRecovery: { // 0-30 –¥–Ω–µ–π
    morning: "–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ! –ö–∞–∂–¥–æ–µ —É—Ç—Ä–æ –≤ —Ç—Ä–µ–∑–≤–æ—Å—Ç–∏ - —ç—Ç–æ –Ω–æ–≤–∞—è –ø–æ–±–µ–¥–∞. –ö–∞–∫ –ø–ª–∞–Ω–∏—Ä—É–µ—Ç–µ –ø—Ä–æ–≤–µ—Å—Ç–∏ —ç—Ç–æ—Ç –¥–µ–Ω—å?",
    afternoon: "–î–µ–Ω—å –Ω–∞–±–∏—Ä–∞–µ—Ç –æ–±–æ—Ä–æ—Ç—ã. –ü–æ–º–Ω–∏—Ç–µ: –≤—ã —Å–∏–ª—å–Ω–µ–µ –ª—é–±—ã—Ö –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ç—Ä—É–¥–Ω–æ—Å—Ç–µ–π.",
    evening: "–í–µ—á–µ—Ä - —á–∞—Å—Ç–æ —Å–ª–æ–∂–Ω–æ–µ –≤—Ä–µ–º—è. –ß–µ–º –∑–∞–π–º–µ—Ç–µ—Å—å —Å–µ–≥–æ–¥–Ω—è –≤–º–µ—Å—Ç–æ —Å—Ç–∞—Ä—ã—Ö –ø—Ä–∏–≤—ã—á–µ–∫?",
    night: "–ù–æ—á—å –º–æ–∂–µ—Ç –ø—Ä–∏–Ω–µ—Å—Ç–∏ –±–µ—Å–ø–æ–∫–æ–π–Ω—ã–µ –º—ã—Å–ª–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Ç–µ—Ö–Ω–∏–∫—É —Ä–∞—Å—Å–ª–∞–±–ª–µ–Ω–∏—è –∏–ª–∏ –º–µ–¥–∏—Ç–∞—Ü–∏—é –Ω–∞ —Å–æ–Ω."
  },
  
  buildingStrength: { // 31-90 –¥–Ω–µ–π
    morning: "–ü—Ä–µ–∫—Ä–∞—Å–Ω–æ–µ —É—Ç—Ä–æ –¥–ª—è —É–∫—Ä–µ–ø–ª–µ–Ω–∏—è –∑–¥–æ—Ä–æ–≤—ã—Ö –ø—Ä–∏–≤—ã—á–µ–∫! –ö–∞–∫—É—é –ø–æ–∑–∏—Ç–∏–≤–Ω—É—é –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–æ–±–∞–≤–∏—Ç–µ –≤ –¥–µ–Ω—å?",
    afternoon: "–°–µ—Ä–µ–¥–∏–Ω–∞ –¥–Ω—è - –≤—Ä–µ–º—è –¥–ª—è –ø–µ—Ä–µ–∑–∞—Ä—è–¥–∫–∏. –ß—Ç–æ –¥–∞–µ—Ç –≤–∞–º —ç–Ω–µ—Ä–≥–∏—é –∏ —Ä–∞–¥–æ—Å—Ç—å?",
    evening: "–í–µ—á–µ—Ä –¥–ª—è —Ä–µ—Ñ–ª–µ–∫—Å–∏–∏. –ß—Ç–æ –Ω–æ–≤–æ–≥–æ –≤—ã —É–∑–Ω–∞–ª–∏ –æ —Å–µ–±–µ –∑–∞ —ç—Ç–æ –≤—Ä–µ–º—è —Ç—Ä–µ–∑–≤–æ—Å—Ç–∏?",
    night: "–ö–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–π —Å–æ–Ω - –æ—Å–Ω–æ–≤–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è. –ì–æ—Ç–æ–≤—ã –∫–æ —Å–Ω—É –∏–ª–∏ –Ω—É–∂–Ω–∞ –ø–æ–º–æ—â—å —Å —Ä–∞—Å—Å–ª–∞–±–ª–µ–Ω–∏–µ–º?"
  },
  
  establishedSobriety: { // 90+ –¥–Ω–µ–π
    morning: "–° –¥–æ–±—Ä—ã–º —É—Ç—Ä–æ–º! –í—ã - –≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ –¥–ª—è –º–Ω–æ–≥–∏—Ö. –ö–∞–∫–∏–º–∏ –ø–ª–∞–Ω–∞–º–∏ –ø–æ–¥–µ–ª–∏—Ç–µ—Å—å?",
    afternoon: "–ü–æ–ª–¥–µ–Ω—å - –≤—Ä–µ–º—è –¥–ª—è –±–æ–ª—å—à–∏—Ö –¥–µ–ª. –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ —Å–≤–æ—é –æ–±—Ä–µ—Ç–µ–Ω–Ω—É—é —è—Å–Ω–æ—Å—Ç—å —É–º–∞?",
    evening: "–í–µ—á–µ—Ä –¥–ª—è –Ω–∞—Å–ª–∞–∂–¥–µ–Ω–∏—è –ø–ª–æ–¥–∞–º–∏ —Å–≤–æ–µ–≥–æ —Ç—Ä—É–¥–∞. –ß–µ–º –≥–æ—Ä–¥–∏—Ç–µ—Å—å —Å–µ–≥–æ–¥–Ω—è?",
    night: "–°–ø–æ–∫–æ–π–Ω–æ–π –Ω–æ—á–∏! –ó–∞–≤—Ç—Ä–∞ –Ω–æ–≤—ã–π –¥–µ–Ω—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π –≤ –≤–∞—à–µ–π —Ç—Ä–µ–∑–≤–æ–π –∂–∏–∑–Ω–∏."
  }
};

// –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
const keywordAnalysis = {
  crisis: ['—Ö–æ—á—É –≤—ã–ø–∏—Ç—å', '–Ω–µ –º–æ–≥—É', '—Å–æ—Ä–≤—É—Å—å', '–Ω–µ–≤—ã–Ω–æ—Å–∏–º–æ', '–ø–æ–º–æ–≥–∏—Ç–µ', '–ø–ª–æ—Ö–æ', '—É–∂–∞—Å–Ω–æ'],
  anxiety: ['—Ç—Ä–µ–≤–æ–≥–∞', '–±–µ—Å–ø–æ–∫–æ–π—Å—Ç–≤–æ', '—Å—Ç—Ä–∞—Ö', '–ø–∞–Ω–∏–∫–∞', '–Ω–µ—Ä–≤–Ω–∏—á–∞—é', '–≤–æ–ª–Ω—É—é—Å—å'],
  sadness: ['–≥—Ä—É—Å—Ç–Ω–æ', '–ø–µ—á–∞–ª—å–Ω–æ', '–¥–µ–ø—Ä–µ—Å—Å–∏—è', '–æ–¥–∏–Ω–æ–∫–æ', '–ø—É—Å—Ç–æ', '—Ç–æ—Å–∫–∞'],
  anger: ['–∑–ª–æ—Å—Ç—å', '–±–µ—à–µ–Ω—Å—Ç–≤–æ', '—Ä–∞–∑–¥—Ä–∞–∂–µ–Ω–∏–µ', '–Ω–µ–Ω–∞–≤–∏—Å—Ç—å', '—è—Ä–æ—Å—Ç—å', '–±–µ—Å–∏—Ç'],
  progress: ['–ª—É—á—à–µ', '—Ö–æ—Ä–æ—à–æ', '–ø—Ä–æ–≥—Ä–µ—Å—Å', '–ø–æ–ª—É—á–∞–µ—Ç—Å—è', '–≥–æ—Ä–¥–æ—Å—Ç—å', '—Å—á–∞—Å—Ç–ª–∏–≤'],
  gratitude: ['—Å–ø–∞—Å–∏–±–æ', '–±–ª–∞–≥–æ–¥–∞—Ä–µ–Ω', '—Ü–µ–Ω—é', '–ø–æ–º–æ–≥–∞–µ—Ç', '–ø–æ–¥–¥–µ—Ä–∂–∫–∞']
};

class LocalAICoach {
  private conversationHistory: Array<{
    user: string;
    ai: string;
    timestamp: Date;
    context: Partial<ConversationContext>;
  }> = [];

  // –ü—Ä–æ—Å—Ç–∞—è –º–æ–¥–µ–ª—å –∞–Ω–∞–ª–∏–∑–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤
  private analyzeMood(message: string): { mood: string; confidence: number } {
    const lowercaseMessage = message.toLowerCase();
    let moodScore = {
      crisis: 0,
      anxiety: 0,
      sadness: 0,
      anger: 0,
      progress: 0,
      gratitude: 0
    };

    // –ü–æ–¥—Å—á–µ—Ç —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤
    Object.entries(keywordAnalysis).forEach(([mood, keywords]) => {
      keywords.forEach(keyword => {
        if (lowercaseMessage.includes(keyword)) {
          moodScore[mood as keyof typeof moodScore] += 1;
        }
      });
    });

    // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–æ–º–∏–Ω–∏—Ä—É—é—â–µ–≥–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è
    const maxMood = Object.entries(moodScore).reduce((a, b) => 
      moodScore[a[0] as keyof typeof moodScore] > moodScore[b[0] as keyof typeof moodScore] ? a : b
    );

    const confidence = Math.min(maxMood[1] / 3, 1); // –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –¥–æ 0-1

    return {
      mood: maxMood[0],
      confidence
    };
  }

  // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞ –æ—Ç–≤–µ—Ç–∞
  private determineUrgency(mood: string, keywords: string[]): ConversationContext['urgency'] {
    if (mood === 'crisis') return 'crisis';
    if (mood === 'anxiety' && keywords.some(k => ['–ø–∞–Ω–∏–∫–∞', '–Ω–µ–≤—ã–Ω–æ—Å–∏–º–æ', '–ø–æ–º–æ–≥–∏—Ç–µ'].includes(k))) {
      return 'high';
    }
    if (['anxiety', 'anger', 'sadness'].includes(mood)) return 'medium';
    return 'low';
  }

  // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∏ –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–π –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π
  private generateResponse(context: ConversationContext, userMessage: string): AIResponse {
    // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–∑—É –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏—Ö –∑–Ω–∞–Ω–∏–π
    const knowledgeMatch = findRelevantKnowledge(userMessage);
    
    if (knowledgeMatch) {
      return {
        message: knowledgeMatch.response,
        suggestions: knowledgeMatch.techniques.slice(0, 3),
        resources: knowledgeMatch.resources,
        mood: 'supportive',
        confidence: 0.9
      };
    }
    
    // –ï—Å–ª–∏ –Ω–µ—Ç —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –ª–æ–≥–∏–∫—É
    const moodAnalysis = this.analyzeMood(userMessage);
    const urgency = this.determineUrgency(moodAnalysis.mood, userMessage.toLowerCase().split(' '));
    
    let responseCategory: keyof typeof responseTemplates;
    let moodType: keyof (typeof responseTemplates)['crisis'];

    // –í—ã–±–æ—Ä –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –æ—Ç–≤–µ—Ç–∞
    if (urgency === 'crisis') {
      responseCategory = 'crisis';
      moodType = 'supportive';
    } else if (urgency === 'high') {
      responseCategory = 'high_urgency';
      moodType = 'motivational';
    } else if (urgency === 'medium') {
      responseCategory = 'medium_urgency';
      moodType = 'analytical';
    } else {
      responseCategory = 'low_urgency';
      moodType = 'calming';
    }

    // –í—ã–±–æ—Ä –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–µ—Ä–∏–æ–¥–∞ —Ç—Ä–µ–∑–≤–æ—Å—Ç–∏
    let personalizedGreeting = '';
    if (context.soberDays <= 30) {
      personalizedGreeting = personalizedResponses.earlyRecovery[context.timeOfDay];
    } else if (context.soberDays <= 90) {
      personalizedGreeting = personalizedResponses.buildingStrength[context.timeOfDay];
    } else {
      personalizedGreeting = personalizedResponses.establishedSobriety[context.timeOfDay];
    }

    // –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ª—É—á–∞–π–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –∏–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    const responses = responseTemplates[responseCategory][moodType];
    const randomResponse = responses[Math.floor(Math.random() * responses.length)];
    
    // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ—Ö–Ω–∏–∫
    const techniques = responseTemplates[responseCategory].techniques || [];
    
    // –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Ç–æ–≥–æ–≤–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
    let finalMessage = '';
    
    if (urgency === 'low_urgency') {
      finalMessage = personalizedGreeting;
    } else {
      finalMessage = randomResponse;
    }

    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–Ω–µ–π —Ç—Ä–µ–∑–≤–æ—Å—Ç–∏
    if (context.soberDays > 0 && urgency !== 'crisis') {
      if (context.soberDays === 1) {
        finalMessage += '\n\n–ü–æ–∑–¥—Ä–∞–≤–ª—è—é —Å –ø–µ—Ä–≤—ã–º –¥–Ω–µ–º —Ç—Ä–µ–∑–≤–æ—Å—Ç–∏! –≠—Ç–æ –æ–≥—Ä–æ–º–Ω—ã–π —à–∞–≥.';
      } else if (context.soberDays === 7) {
        finalMessage += '\n\nüéâ –ù–µ–¥–µ–ª—è —Ç—Ä–µ–∑–≤–æ—Å—Ç–∏! –≠—Ç–æ —Å–µ—Ä—å–µ–∑–Ω–æ–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ.';
      } else if (context.soberDays === 30) {
        finalMessage += '\n\nüèÜ –ú–µ—Å—è—Ü —Ç—Ä–µ–∑–≤–æ—Å—Ç–∏ - –≤—ã –Ω–µ–≤–µ—Ä–æ—è—Ç–Ω—ã! –í–∞—à–µ —Ç–µ–ª–æ –±–ª–∞–≥–æ–¥–∞—Ä–∏—Ç –≤–∞—Å.';
      } else if (context.soberDays % 30 === 0) {
        finalMessage += `\n\n‚ú® ${Math.floor(context.soberDays / 30)} –º–µ—Å—è—Ü–µ–≤ —Ç—Ä–µ–∑–≤–æ—Å—Ç–∏! –í—ã –≤–¥–æ—Ö–Ω–æ–≤–ª—è–µ—Ç–µ –¥—Ä—É–≥–∏—Ö.`;
      }
    }

    return {
      message: finalMessage,
      suggestions: this.generateSuggestions(context, moodAnalysis.mood),
      resources: this.getRelevantResources(urgency, moodAnalysis.mood),
      mood: moodType,
      confidence: moodAnalysis.confidence
    };
  }

  // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –¥–µ–π—Å—Ç–≤–∏–π
  private generateSuggestions(context: ConversationContext, detectedMood: string): string[] {
    const baseSuggestions = {
      crisis: [
        '–ü–æ–∑–≤–æ–Ω–∏—Ç–µ –¥—Ä—É–≥—É –∏–ª–∏ —Ä–æ–¥—Å—Ç–≤–µ–Ω–Ω–∏–∫—É',
        '–°—Ö–æ–¥–∏—Ç–µ –Ω–∞ –ø—Ä–æ–≥—É–ª–∫—É –∏–ª–∏ —Å–¥–µ–ª–∞–π—Ç–µ —Ñ–∏–∑–∏—á–µ—Å–∫–∏–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è',
        '–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—ã—Ö–∞—Ç–µ–ª—å–Ω—É—é —Ç–µ—Ö–Ω–∏–∫—É',
        '–ü—Ä–∏–º–∏—Ç–µ —Ö–æ–ª–æ–¥–Ω—ã–π –¥—É—à –¥–ª—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏'
      ],
      anxiety: [
        '–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –º–µ–¥–∏—Ç–∞—Ü–∏—é –∏–ª–∏ –¥—ã—Ö–∞—Ç–µ–ª—å–Ω—ã–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è',
        '–í—ã–π–¥–∏—Ç–µ –Ω–∞ —Å–≤–µ–∂–∏–π –≤–æ–∑–¥—É—Ö',
        '–ü–æ—Å–ª—É—à–∞–π—Ç–µ —É—Å–ø–æ–∫–∞–∏–≤–∞—é—â—É—é –º—É–∑—ã–∫—É',
        '–°–¥–µ–ª–∞–π—Ç–µ —á—Ç–æ-—Ç–æ —Ç–≤–æ—Ä—á–µ—Å–∫–æ–µ'
      ],
      sadness: [
        '–ü–æ–≥–æ–≤–æ—Ä–∏—Ç–µ —Å –∫–µ–º-—Ç–æ, –∫–æ–º—É –¥–æ–≤–µ—Ä—è–µ—Ç–µ',
        '–ó–∞–ø–∏—à–∏—Ç–µ —Å–≤–æ–∏ —á—É–≤—Å—Ç–≤–∞ –≤ –¥–Ω–µ–≤–Ω–∏–∫',
        '–°–¥–µ–ª–∞–π—Ç–µ —á—Ç–æ-—Ç–æ –¥–æ–±—Ä–æ–µ –¥–ª—è —Å–µ–±—è',
        '–ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –º–æ—Ç–∏–≤–∏—Ä—É—é—â–∏–π —Ñ–∏–ª—å–º –∏–ª–∏ –≤–∏–¥–µ–æ'
      ],
      default: [
        '–û—Ç–º–µ—Ç—å—Ç–µ —Å–≤–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å –≤ –¥–Ω–µ–≤–Ω–∏–∫–µ',
        '–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –Ω–æ–≤–æ–µ –ù–õ–ü —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ',
        '–ü–æ—Å–ª—É—à–∞–π—Ç–µ —Ç–µ—Ä–∞–ø–µ–≤—Ç–∏—á–µ—Å–∫–∏–µ –∑–≤—É–∫–∏',
        '–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å —É—Å–ø–µ—Ö–æ–º —Å —Å–æ–æ–±—â–µ—Å—Ç–≤–æ–º'
      ]
    };

    const suggestions = baseSuggestions[detectedMood as keyof typeof baseSuggestions] || baseSuggestions.default;
    
    // –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤—Ä–µ–º–µ–Ω–∏ –¥–Ω—è
    if (context.timeOfDay === 'morning') {
      suggestions.push('–ù–∞—á–Ω–∏—Ç–µ –¥–µ–Ω—å —Å –ø–æ–∑–∏—Ç–∏–≤–Ω–æ–π –∞—Ñ—Ñ–∏—Ä–º–∞—Ü–∏–∏');
    } else if (context.timeOfDay === 'evening') {
      suggestions.push('–ü–æ–¥–≥–æ—Ç–æ–≤—å—Ç–µ—Å—å –∫–æ —Å–Ω—É —Å —Ä–∞—Å—Å–ª–∞–±–ª—è—é—â–µ–π –ø—Ä–æ—Ü–µ–¥—É—Ä–æ–π');
    }

    return suggestions.slice(0, 3); // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–æ–ª—å–∫–æ 3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
  }

  // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö —Ä–µ—Å—É—Ä—Å–æ–≤
  private getRelevantResources(urgency: ConversationContext['urgency'], mood: string): string[] {
    const resources = {
      crisis: [
        '–≠–∫—Å—Ç—Ä–µ–Ω–Ω–∞—è –ø–æ–º–æ—â—å –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏',
        '–ì–æ—Ä—è—á–∞—è –ª–∏–Ω–∏—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏',
        '–¢–µ—Ö–Ω–∏–∫–∏ –∫—Ä–∏–∑–∏—Å–Ω–æ–≥–æ –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–∞',
        '–î—ã—Ö–∞—Ç–µ–ª—å–Ω—ã–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –¥–ª—è –ø–∞–Ω–∏–∫–∏'
      ],
      high: [
        '–ù–õ–ü —Ç–µ—Ö–Ω–∏–∫–∏ –¥–ª—è –ø—Ä–µ–æ–¥–æ–ª–µ–Ω–∏—è —Ç—è–≥–∏',
        '–ê—É–¥–∏–æ-—Å–µ—Å—Å–∏–∏ –¥–ª—è —É—Å–ø–æ–∫–æ–µ–Ω–∏—è',
        '–°–æ–æ–±—â–µ—Å—Ç–≤–æ –ø–æ–¥–¥–µ—Ä–∂–∫–∏',
        '–ú–æ—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω—ã–µ –∏—Å—Ç–æ—Ä–∏–∏'
      ],
      medium: [
        '–ü—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ —Ç–µ—Ö–Ω–∏–∫–∏ CBT',
        '–£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –æ—Å–æ–∑–Ω–∞–Ω–Ω–æ—Å—Ç–∏',
        '–ê–Ω–∞–ª–∏–∑ —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤',
        '–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–Ω—è'
      ],
      low: [
        '–û–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã',
        '–ò—Å—Ç–æ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞',
        '–ó–¥–æ—Ä–æ–≤—ã–µ –ø—Ä–∏–≤—ã—á–∫–∏',
        '–î–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ–µ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ'
      ]
    };

    return resources[urgency] || resources.low;
  }

  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –≤–≤–æ–¥–∞
  private updateContext(currentContext: ConversationContext, userMessage: string): ConversationContext {
    const moodAnalysis = this.analyzeMood(userMessage);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–ø—Ä–æ—Å—Ç–∞—è —ç–≤—Ä–∏—Å—Ç–∏–∫–∞)
    let newMoodScore = currentContext.userMood;
    
    if (moodAnalysis.mood === 'progress' || moodAnalysis.mood === 'gratitude') {
      newMoodScore = Math.min(5, currentContext.userMood + 1);
    } else if (moodAnalysis.mood === 'crisis' || moodAnalysis.mood === 'sadness') {
      newMoodScore = Math.max(1, currentContext.userMood - 1);
    }

    return {
      ...currentContext,
      userMood: newMoodScore,
      urgency: this.determineUrgency(moodAnalysis.mood, userMessage.toLowerCase().split(' '))
    };
  }

  // –û—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ç–æ–¥ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞
  public async getResponse(userMessage: string, context: ConversationContext): Promise<AIResponse> {
    // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç
    const updatedContext = this.updateContext(context, userMessage);
    
    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç
    const response = this.generateResponse(updatedContext, userMessage);
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏–∏
    this.conversationHistory.push({
      user: userMessage,
      ai: response.message,
      timestamp: new Date(),
      context: updatedContext
    });

    // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –∏—Å—Ç–æ—Ä–∏–∏
    if (this.conversationHistory.length > 50) {
      this.conversationHistory = this.conversationHistory.slice(-25);
    }

    return response;
  }

  // –ü–æ–ª—É—á–µ–Ω–∏–µ –±—ã—Å—Ç—Ä–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –¥–ª—è –∫—Ä–∏–∑–∏—Å–Ω—ã—Ö —Å–∏—Ç—É–∞—Ü–∏–π
  public async getQuickSupport(urgencyLevel: 'high' | 'crisis' = 'high'): Promise<AIResponse> {
    const crisisResponse = urgencyLevel === 'crisis' 
      ? responseTemplates.crisis.supportive[0]
      : responseTemplates.high_urgency.motivational[0];
    
    return {
      message: crisisResponse,
      suggestions: [
        '–î—ã—à–∏—Ç–µ –º–µ–¥–ª–µ–Ω–Ω–æ –∏ –≥–ª—É–±–æ–∫–æ',
        '–ù–∞–∑–æ–≤–∏—Ç–µ 5 –≤–µ—â–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –≤–∏–¥–∏—Ç–µ',
        '–í—ã–ø–µ–π—Ç–µ —Å—Ç–∞–∫–∞–Ω —Ö–æ–ª–æ–¥–Ω–æ–π –≤–æ–¥—ã',
        '–û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∑–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π'
      ],
      resources: [
        '–≠–∫—Å—Ç—Ä–µ–Ω–Ω—ã–µ —Ç–µ—Ö–Ω–∏–∫–∏',
        '–î—ã—Ö–∞—Ç–µ–ª—å–Ω—ã–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è',
        '–ì–æ—Ä—è—á–∞—è –ª–∏–Ω–∏—è –ø–æ–º–æ—â–∏',
        '–ö—Ä–∏–∑–∏—Å–Ω–æ–µ –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–æ'
      ],
      mood: 'supportive',
      confidence: 1.0
    };
  }

  // –ü–æ–ª—É—á–µ–Ω–∏–µ –º–æ—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
  public async getMotivationalMessage(soberDays: number): Promise<string> {
    if (soberDays === 0) {
      return "–°–µ–≥–æ–¥–Ω—è –ø–µ—Ä–≤—ã–π –¥–µ–Ω—å –≤–∞—à–µ–π –Ω–æ–≤–æ–π –∂–∏–∑–Ω–∏. –ö–∞–∂–¥—ã–π –º–æ–º–µ–Ω—Ç —Ç—Ä–µ–∑–≤–æ—Å—Ç–∏ - —ç—Ç–æ –∞–∫—Ç –ª—é–±–≤–∏ –∫ —Å–µ–±–µ.";
    } else if (soberDays <= 7) {
      return `${soberDays} –¥–Ω–µ–π —Å–∏–ª—ã –∏ –º—É–∂–µ—Å—Ç–≤–∞! –í–∞—à –º–æ–∑–≥ —É–∂–µ –Ω–∞—á–∏–Ω–∞–µ—Ç –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å—Å—è.`;
    } else if (soberDays <= 30) {
      return `${soberDays} –¥–Ω–µ–π —Ç—Ä–µ–∑–≤–æ—Å—Ç–∏! –í–∞—à–µ —Ç–µ–ª–æ –±–ª–∞–≥–æ–¥–∞—Ä–∏—Ç –≤–∞—Å –∑–∞ –∫–∞–∂–¥—ã–π —Ç—Ä–µ–∑–≤—ã–π –¥–µ–Ω—å.`;
    } else if (soberDays <= 90) {
      return `${soberDays} –¥–Ω–µ–π - —ç—Ç–æ —Å–µ—Ä—å–µ–∑–Ω–æ–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ! –í—ã —Å–æ–∑–¥–∞–µ—Ç–µ –Ω–æ–≤—ã–µ –Ω–µ–π—Ä–æ–Ω–Ω—ã–µ –ø—É—Ç–∏ —É—Å–ø–µ—Ö–∞.`;
    } else {
      return `${soberDays} –¥–Ω–µ–π —Ç—Ä–µ–∑–≤–æ—Å—Ç–∏! –í—ã - –∂–∏–≤–æ–µ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ —Ç–æ–≥–æ, —á—Ç–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤–æ–∑–º–æ–∂–Ω—ã.`;
    }
  }

  // –ê–Ω–∞–ª–∏–∑ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –≤ –∏—Å—Ç–æ—Ä–∏–∏ —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤
  public getInsights(): { patterns: string[]; recommendations: string[] } {
    if (this.conversationHistory.length < 5) {
      return {
        patterns: ['–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞'],
        recommendations: ['–ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –æ–±—â–µ–Ω–∏–µ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π']
      };
    }

    const recentConversations = this.conversationHistory.slice(-10);
    
    // –ê–Ω–∞–ª–∏–∑ —á–∞—Å—Ç—ã—Ö —Ç–µ–º
    const topics: Record<string, number> = {};
    recentConversations.forEach(conv => {
      const mood = this.analyzeMood(conv.user).mood;
      topics[mood] = (topics[mood] || 0) + 1;
    });

    const mostFrequentTopic = Object.entries(topics).reduce((a, b) => a[1] > b[1] ? a : b)[0];
    
    const patterns = [
      `–ß–∞—â–µ –≤—Å–µ–≥–æ –æ–±—Ä–∞—â–∞–µ—Ç–µ—Å—å —Å —Ç–µ–º–æ–π: ${mostFrequentTopic}`,
      `–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±—Ä–∞—â–µ–Ω–∏–π: ${this.conversationHistory.length}`,
      `–°—Ä–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: ${(this.conversationHistory.length / 7).toFixed(1)} –æ–±—Ä–∞—â–µ–Ω–∏–π –≤ –Ω–µ–¥–µ–ª—é`
    ];

    const recommendations = [
      mostFrequentTopic === 'anxiety' ? '–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º –±–æ–ª—å—à–µ –ø—Ä–∞–∫—Ç–∏–∫ –æ—Å–æ–∑–Ω–∞–Ω–Ω–æ—Å—Ç–∏' : '–ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ —Ç–µ–∫—É—â—É—é —Å—Ç—Ä–∞—Ç–µ–≥–∏—é',
      '–†–µ–≥—É–ª—è—Ä–Ω–æ–µ –æ–±—â–µ–Ω–∏–µ —Å AI-–∫–æ—É—á–µ–º –ø–æ–º–æ–≥–∞–µ—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å',
      '–†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≤–µ–¥–µ–Ω–∏—è –¥–Ω–µ–≤–Ω–∏–∫–∞ —ç–º–æ—Ü–∏–π'
    ];

    return { patterns, recommendations };
  }

  // –û—á–∏—Å—Ç–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏
  public clearHistory(): void {
    this.conversationHistory = [];
  }

  // –≠–∫—Å–ø–æ—Ä—Ç –∏—Å—Ç–æ—Ä–∏–∏ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
  public exportHistory(): string {
    return JSON.stringify(this.conversationHistory, null, 2);
  }
}

export { LocalAICoach, type AIResponse, type ConversationContext };